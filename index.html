<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>分数名人君</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 2em;
    }
    .fraction-container, .answer-container, .result-area {
      text-align: center;
      margin: 1em auto;
      font-size: 1.5em;
    }
    .fraction {
      display: inline-block;
      text-align: center;
      margin: 0 0.3em;
    }
    .fraction .numerator {
      display: block;
    }
    .fraction .denominator {
      display: block;
      border-top: 1px solid black;
    }
    .fraction-input input {
      width: 3em;
      font-size: 1em;
      text-align: center;
      border: 1px solid #aaa;
      margin: 0.2em;
    }
    button {
      font-size: 1em;
      margin: 0.5em;
      padding: 0.5em 1em;
    }
  </style>
</head>
<body>
  <h1>分数名人君</h1>

  <div id="problem" class="fraction-container"></div>

  <div id="answer-area" class="answer-container">
    <div class="fraction-input">
      <input id="user-numerator" type="number" placeholder="?" />
      <hr />
      <input id="user-denominator" type="number" placeholder="?" />
    </div>
    <button onclick="checkAnswer()">答えを見る</button>
  </div>

  <div id="result" class="result-area"></div>
  <div id="retry-buttons" style="display:none;">
    <button onclick="retryProblem()">再挑戦する</button>
    <button onclick="showCorrectAnswer()">答えを見る</button>
  </div>

  <button onclick="showNewProblem()">次の問題</button>

  <script>
    let currentProblem;
    let showAnswer = false;

    function gcd(a, b) {
      return b === 0 ? a : gcd(b, a % b);
    }

    function generateProblem() {
      let a, b, e, f, m, n, c, d;

      do {
        do {
          a = Math.floor(Math.random() * 20) + 1;
          b = Math.floor(Math.random() * 19) + 2;
        } while (gcd(a, b) !== 1);

        do {
          e = Math.floor(Math.random() * 20) + 1;
          f = Math.floor(Math.random() * 19) + 2;
        } while (gcd(e, f) !== 1);

        let tries = 0;
        do {
          m = Math.floor(Math.random() * 10) + 1;
          n = Math.floor(Math.random() * 10) + 1;
          c = m * b * f;
          d = n * a * e;
          tries++;
          if (tries > 10) break;
        } while (gcd(c, d) !== 1);

      } while (c > 200 || d > 200 || gcd(c, d) !== 1);

      return {
        fractions: [[a, b], [c, d], [e, f]]
      };
    }

    function displayProblem(problem) {
      const container = document.getElementById("problem");
      container.innerHTML = "";

      const parts = problem.fractions.map(([num, den]) => `
        <span class="fraction">
          <span class="numerator">${num}</span>
          <span class="denominator">${den}</span>
        </span>`);

      container.innerHTML = parts.join("<span style='font-size: 1.2em;'>×</span>");
    }

    function checkAnswer() {
      const userNum = parseInt(document.getElementById("user-numerator").value);
      const userDen = parseInt(document.getElementById("user-denominator").value);

      if (!userNum || !userDen) {
        document.getElementById("result").innerHTML = "⚠️ 分子と分母を入力してください。";
        return;
      }

      const [a, b] = currentProblem.fractions[0];
      const [c, d] = currentProblem.fractions[1];
      const [e, f] = currentProblem.fractions[2];

      let num = a * c * e;
      let den = b * d * f;
      const divisor = gcd(num, den);
      const correctNum = num / divisor;
      const correctDen = den / divisor;

      const isCorrect = (userNum === correctNum && userDen === correctDen);

      if (isCorrect) {
        document.getElementById("result").innerHTML = `⭕ 正解！<br>
          <div class="fraction">
            <span class="numerator">${correctNum}</span>
            <span class="denominator">${correctDen}</span>
          </div>`;
        document.getElementById("retry-buttons").style.display = "none";
      } else {
        document.getElementById("result").innerHTML = "❌ 不正解…";
        document.getElementById("retry-buttons").style.display = "block";
        showAnswer = false;
      }
    }

    function showCorrectAnswer() {
      const [a, b] = currentProblem.fractions[0];
      const [c, d] = currentProblem.fractions[1];
      const [e, f] = currentProblem.fractions[2];

      let num = a * c * e;
      let den = b * d * f;
      const divisor = gcd(num, den);
      const correctNum = num / divisor;
      const correctDen = den / divisor;

      document.getElementById("result").innerHTML = `正解：<br>
        <div class="fraction">
          <span class="numerator">${correctNum}</span>
          <span class="denominator">${correctDen}</span>
        </div>`;
      document.getElementById("retry-buttons").style.display = "none";
    }

    function retryProblem() {
      document.getElementById("user-numerator").value = "";
      document.getElementById("user-denominator").value = "";
      document.getElementById("result").innerHTML = "";
      document.getElementById("retry-buttons").style.display = "none";
    }

    function showNewProblem() {
      currentProblem = generateProblem();
      displayProblem(currentProblem);
      retryProblem();
    }

    showNewProblem();
  </script>
</body>
</html>
